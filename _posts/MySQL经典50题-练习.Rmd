---
title: "MySQL经典50题-练习"
author: "程昊"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,comment = "")
```

```{r}
library(bruceR)
library(tidyverse)
library(lubridate)
student = tribble(
  ~学号, ~姓名, ~生日, ~性别,
  '01', '赵雷', '1990-01-01', '男', 
  '02', '钱电', '1990-12-21', '男',
  '03', '孙风', '1990-05-20', '男',
  '04', '李云', '1990-08-06', '男',
  '05', '周梅', '1991-12-01', '女',
  '06', '吴兰', '1992-03-01', '女',
  '07', '郑竹', '1989-07-01', '女',
  '08', '王菊', '1990-01-20', '女'
)
student

score = tribble(
  ~学号, ~课程编号, ~成绩,
  '01', '01', 80,
  '01', '02', 90,
  '01', '03', 99,
  '02', '01', 70,
  '02', '02', 60,
  '02', '03', 80,
  '03', '01', 80,
  '03', '02', 80,
  '03', '03', 80,
  '04', '01', 50,
  '04', '02', 30,
  '04', '03', 20,
  '05', '01', 76,
  '05', '02', 87,
  '06', '01', 31,
  '06', '03', 34,
  '07', '02', 89,
  '07', '03', 98
)
score

course = tribble(
  ~课程编号, ~课程名称, ~教师编号,
  '01', '语文', '02',
  '02', '数学', '01',
  '03', '英语', '03'
)
course

teacher = tribble(
  ~教师编号, ~教师姓名,
  '01', '张三',
  '02', '李四',
  '03', '王五'
)
teacher
```

1. 查询"01"课程比"02"课程成绩**高**的学生的信息及课程分数

```{r}
score %>% 
  pivot_wider(names_from = 课程编号,values_from = 成绩, names_prefix = "课程") %>% 
  filter(课程01 > 课程02) %>% 
  left_join(student, by = "学号")
```

2. 查询"01"课程比"02"课程成绩**低**的学生的信息及课程分数

```{r}
score %>% 
  pivot_wider(names_from = 课程编号,values_from = 成绩, names_prefix = "课程") %>% 
  filter(课程01 < 课程02) %>% 
  left_join(student, by = "学号")
```

3. 查询平均成绩大于等于60分的学生学号、姓名和平均成绩

```{r}
score %>% 
  summarise(平均成绩 = mean(成绩), .by = 学号) %>% 
  filter(平均成绩 >= 60) %>% 
  left_join(student, by = "学号") %>% 
  select(学号, 姓名, 平均成绩)
```

附加题: 总分超过200分的学生学号、姓名、总分

```{r}
score %>% 
  summarise(总分 = sum(成绩), .by = 学号) %>% 
  filter(总分 >= 200) %>% 
  left_join(student, by = "学号") %>% 
  select(学号, 姓名, 总分)
```

4. 查询平均成绩小于60 分的学生的学号和姓名和平均成绩（包括有成绩的和无成绩的）

```{r}
# 有成绩的
score %>% 
  summarise(平均成绩 = mean(成绩), .by = 学号) %>% 
  filter(平均成绩 < 60) %>% 
  left_join(student, by = "学号") %>% 
  select(学号, 姓名, 平均成绩)

# 没成绩的(08号王菊)
student %>% 
  left_join(score, by = "学号") %>% 
  summarise(平均成绩 = mean(成绩), .by = c(学号, 姓名)) %>% 
  replace_na(list(平均成绩 = 0)) %>% 
  filter(平均成绩 < 60)
```

5. 查询所有学生的学号、姓名、选课总数、所有课程的总成绩

```{r}
student %>% 
  left_join(score, by = "学号") %>% 
  mutate(成绩 = replace_na(成绩, 0)) %>% 
  summarise(选课总数 = n_distinct(课程编号, na.rm = T),
            总成绩 = sum(成绩),
            .by = c(学号, 姓名))
```

6. 查询"李"姓老师的数量

```{r}
teacher %>% 
  mutate(是否李姓 = ifelse(str_sub(教师姓名, end = 1) == "李", TRUE, FALSE)) %>% 
  summarise(n = n(), .by = 是否李姓)

teacher %>% 
  count(是否李姓 = str_detect(教师姓名, "^李"))
```

7. 查询学过张三老师授课的同学的信息

```{r}
teacher %>% 
  filter(教师姓名 == "张三") %>% 
  left_join(course, by = "教师编号") %>% 
  left_join(score, by = "课程编号") %>% 
  semi_join(x = student, y = ., by = "学号")
```

8. 找出没有学过张三老师课程的学生

```{r}
teacher %>% 
  filter(教师姓名 == "张三") %>% 
  left_join(course, by = "教师编号") %>% 
  left_join(score, by = "课程编号") %>% 
  anti_join(student, ., by = "学号")
```

9. 查询学过"01"和"02"课程的学生信息

```{r}
semi_join(
    score %>% 
  filter(课程编号 == "01"),
    score %>% 
  filter(课程编号 == "02"),
  by = "学号") %>% 
  semi_join(student, ., by = "学号")

score %>% 
  pivot_wider(names_from = 课程编号, values_from = 成绩,
              names_prefix = "课程") %>% 
  filter(!is.na(课程01), !is.na(课程02)) %>% 
  semi_join(student, ., by = "学号")
```

10. 查询学过"01"课程，但没有学过"02"课程的学生信息

```{r}
anti_join(
    score %>% 
  filter(课程编号 == "01"),
    score %>% 
  filter(课程编号 == "02"),
  by = "学号") %>% 
  semi_join(student, ., by = "学号")

score %>% 
  pivot_wider(names_from = 课程编号, values_from = 成绩) %>% 
  filter(!is.na(`01`),is.na(`02`)) %>% 
  semi_join(student, ., by = "学号")

```

11. 查询没有学完全部课程的学生信息

```{r}
course %>% 
  left_join(score, by = "课程编号") %>% 
  select(课程编号,成绩,学号) %>% 
  pivot_wider(names_from = 课程编号, values_from = 成绩, names_prefix = "课程") %>% 
  drop_na() %>% 
  anti_join(student, ., by = "学号")

score %>% 
  group_by(学号) %>% 
  filter(n() == nrow(course)) %>% 
  anti_join(student, ., by = "学号")
```

12. 查询至少有一门课与学生"01"所学课程相同的学生的信息

```{r}
score %>% 
  filter(学号 == "01") %>%
  semi_join(score, ., by = "课程编号") %>% 
  semi_join(student, ., by = "学号")
```

13. 查询与学生"01"学习的课程完全相同的学生信息

```{r}
score %>% 
  arrange(学号, 课程编号) %>% 
  summarise(课程汇编 = str_c(课程编号, collapse = " "), .by = 学号) %>% 
  filter(课程汇编 == .$课程汇编[1]) %>%
  semi_join(student, ., by = "学号")

# 另一种思路
# c01 = score %>% 
#   filter(学号 == "01")
# 
# score %>% 
#   group_nest(学号) %>% 
#   filter(map_lgl(data, ~ setequal(.x$课程编号, c01$课程编号))) %>%
#   semi_join(student, ., by = "学号")
```

14. 同 8. (略)

15. 查询两门及其以上不及格课程的学生学号，姓名及其平均成绩

```{r}
score %>% 
  filter(成绩 < 60) %>% 
  filter(n() >= 2, .by = 学号) %>% 
  summarise(平均成绩 = mean(成绩), .by = 学号) %>% 
  left_join(student, by = "学号") %>% 
  select(学号, 姓名, 平均成绩)
```

16. 检索"01"课程分数小于60，按分数降序排列的学生信息

```{r}
score %>% 
  filter(课程编号 == '01', 成绩 < 60) %>% 
  arrange(-成绩) %>% 
  left_join(student, by = '学号') %>% 
  select(-课程编号)
```

17. 按平均成绩从高到低显示所有学生的所有课程的成绩以及平均成绩

```{r}
# 长表
score %>% 
  mutate(平均成绩 = mean(成绩), .by = 学号) %>% 
  arrange(-平均成绩)

# 宽表
score %>% 
  pivot_wider(names_from = 课程编号, names_prefix = "课程", values_from = 成绩) %>% 
  mutate(平均成绩 = pmap_dbl(.[-1], ~mean(c(...), na.rm = TRUE))) %>% 
  arrange(-平均成绩)
```

18. 查询各科成绩最高分、最低分和平均分，以如下形式显示：
- 课程编号，课程名称，最高分，最低分，平均分，及格率，中等率，优良率，优秀率；
**注：** 及格：>=60，中等为：70-80，优良为：80-90，优秀为：>=90

```{r}
score %>% 
  left_join(course, by = "课程编号") %>% 
  summarise(最高分 = max(成绩),
            最低分 = min(成绩),
            平均分 = mean(成绩),
            及格率 = mean(成绩 >= 60), 
            中等率 = mean(成绩 >= 70 & 成绩 < 80),
            优秀率 = mean(成绩 >= 90),
            .by = c(课程编号,课程名称))
```

19. 按照各科成绩进行排序，并且显示排名

```{r}
score %>% 
  arrange(课程编号, -成绩) %>% 
  mutate(排名 = min_rank(-成绩), .by = 课程编号)
```

20. 查询学生的总成绩，并进行排名

```{r}
score %>% 
  summarise(总成绩 = sum(成绩), .by = 学号) %>% 
  arrange(desc(总成绩)) %>% 
  mutate(排名 = min_rank(-总成绩))
```

21. 查询不同老师所教不同课程平均分从高到低显示

```{r}
score %>% 
  summarise(平均分 = mean(成绩), .by = c(课程编号)) %>% 
  left_join(course, by = "课程编号") %>% 
  left_join(teacher, by = "教师编号") %>% 
  select(教师姓名, 课程名称, 平均分) %>% 
  arrange(-平均分)
```

22. 查询所有课程的成绩第2至3名的学生信息及该课程成绩

```{r}
score %>% 
  mutate(排名 = row_number(-成绩), .by = 课程编号) %>% 
  filter(排名 %in% 2:3) %>% 
  left_join(student, by = "学号") %>% 
  arrange(课程编号)
```

23. 统计各科成绩各分数段人数：课程编号，课程名称，[100-85]，[85-70]，[70-60]，[0-60] 及所占百分比

```{r}
score %>% 
  left_join(course, by = "课程编号") %>% 
  mutate(分数段 = cut(成绩, breaks = c(0,60,70,85,100), right = FALSE)) %>% 
  summarise(.by = c(课程编号, 课程名称, 分数段), 人数 = n()) %>% 
  mutate(百分比 = scales::percent(人数/sum(人数), 0.01), .by = 课程编号) %>% 
  arrange(课程编号,分数段)
```

24. 查询学生的平均成绩及名次

```{r}
score %>% 
  summarise(平均成绩 = mean(成绩), .by = 学号) %>% 
  mutate(名次 = min_rank(-平均成绩)) %>% 
  arrange(名次)
```

25. 查询各科成绩前三名的记录

```{r}
score %>% slice_max(成绩, n = 3, by = 课程编号)
```

26. 查询每门课被选修的学生数

```{r}
score %>% count(课程编号)
```

27. 查询出只有两门课程的全部学生的学号和姓名

```{r}
score %>% 
  count(学号) %>% 
  filter(n == 2) %>% 
  left_join(student) %>% 
  select(学号, 姓名)
```

28. 查询男女生人数

```{r}
student %>% count(性别)
```

29. 查询名字中含有风字的学生信息

```{r}
student %>% filter(str_detect(姓名, "风"))
```

30. 查询同姓名同性别的学生名单，并统计同姓名人数

```{r}
student %>% 
  add_count(姓名, 性别) # %>% 
  # filter(n > 1) %>% 
  # summarise(人数 = sum(n))
```

31. 查询1990年出生的学生信息

```{r}
student %>% 
  filter(str_detect(生日, "^1990"))

student %>% 
  filter(year(生日) == 1990)
```

32. 计算每门课程的平均成绩，并按降序排列；若平均成绩相同，按课程编号升序排列

```{r}
score %>% 
  summarise(平均成绩 = mean(成绩), .by = 课程编号) %>% 
  arrange(-平均成绩, 课程编号)
```

33. 查询平均成绩大于等于85分的学生学号、姓名和平均成绩

```{r}
score %>% 
  summarise(平均成绩 = mean(成绩), .by = 学号) %>% 
  filter(平均成绩 >= 85) %>% 
  left_join(student, by = "学号") %>% 
  select(学号, 姓名, 平均成绩)
```

34. 查询课程名称为数学，且分数低于60的学生姓名和分数

```{r}
score %>% 
  left_join(course, by = "课程编号") %>% 
  filter(课程名称 == "数学", 成绩 < 60) %>% 
  left_join(student, by = "学号") %>% 
  select(姓名, 成绩)
```

35. 查询所有学生的课程及分数情况

```{r}
score %>% 
  left_join(course, by = "课程编号") %>% 
  select(学号, 课程名称, 成绩) %>% 
  pivot_wider(names_from = 课程名称, values_from = 成绩) %>% 
  right_join(student, by = "学号") %>% 
  select(学号, 姓名, everything(), -生日, -性别) %>% 
  mutate(总分 = pmap_dbl(.[3:5], sum, na.rm=TRUE))
```

36. 查询任何一门课程成绩都在70分以上的姓名、课程名称和分数

```{r}
# 不考虑缺失
score %>% 
  left_join(course, by = "课程编号") %>% 
  select(学号, 课程名称, 成绩) %>% 
  pivot_wider(names_from = 课程名称, values_from = 成绩) %>% 
  filter_if(is.numeric, all_vars(.>70)) %>% 
  left_join(student, by = "学号") %>% 
  select(姓名, 语文, 数学, 英语)

# 考虑缺失
score %>% 
  left_join(course, by = "课程编号") %>% 
  select(学号, 课程名称, 成绩) %>% 
  pivot_wider(names_from = 课程名称, values_from = 成绩) %>% 
  filter_if(is.numeric, all_vars(.>70 | is.na(.))) %>% 
  left_join(student, by = "学号") %>% 
  select(姓名, 语文, 数学, 英语)
```

37. 查询不及格的课程

```{r}
score %>% 
  filter(成绩 < 60) %>% 
  left_join(course, by = "课程编号") %>% 
  select(课程编号, 课程名称, 成绩)
```

38. 查询课程01的成绩大于等于80的学生学号和姓名

```{r}
score %>% 
  filter(课程编号 == "01", 成绩 >= 80) %>% 
  semi_join(student, ., by = "学号") %>% 
  select(学号, 姓名)
```

40. 查询选修"张三"老师所授课程的学生中，成绩最高的学生信息及其成绩

```{r}
teacher %>% 
  filter(教师姓名 == "张三") %>% 
  left_join(course, by = "教师编号") %>% 
  semi_join(score, ., by = "课程编号") %>% 
  slice_max(成绩) %>% 
  left_join(student, by = "学号")
```

41. 查询不同课程成绩相同的学生学号、课程编号、学生成绩

```{r}
score %>% 
  count(成绩) %>% 
  filter(n > 1) %>% 
  semi_join(score, ., by = "成绩")
```

42. 查询每门课程成绩最好的前两名

```{r}
score %>% slice_max(成绩, by = 课程编号, n = 2)
```

43. 统计每门课程的学生选修人数（超过5人的课程才统计）。要求输出课程号和选修人数，查询结果按人数降序排列，若人数相同，按课程号升序排列

```{r}
score %>% 
  count(课程编号) %>% 
  filter(n > 5) %>% 
  arrange(n, 课程编号)
```

44. 检索至少选修两门课程的学生学号

```{r}
score %>% 
  count(学号) %>% 
  filter(n > 2)
```

45. 查询选修了全部课程的学生信息

```{r}
score %>% 
  count(学号) %>% 
  filter(n == n_distinct(course$课程编号)) %>% 
  semi_join(student, ., by = "学号")
```

46. 查询各学生的年龄: 按照出生日期来算, 当前月日<出生年月的月日, 则年龄减1

```{r}
student %>% 
  mutate(年龄 = interval(生日, today()) %/% dyears(1))
```

47. 查询本周过生日的学生

```{r}
student %>% 
  filter(week(today()) == week(生日))
```

48. 查询下周过生日的学生

```{r}
student %>% 
  filter(week(today())+1 == week(生日))
```

49. 查询本月过生日的学生

```{r}
student %>% 
  filter(month(today()) == month(生日))
```

50. 查询下月过生日的学生

```{r}
student %>% 
  filter(month(today())+1 == month(生日))
```


